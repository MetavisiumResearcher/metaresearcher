<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<title>GhoT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<link rel="icon" type="image/png" sizes="64x64" href="favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
<style>
  body { background:#000; color:#0f0; font-family:monospace; text-align:center; padding:15px; }
  #status { margin:10px; font-size:16px; }
  textarea { width:95%; height:200px; background:#111; color:#0f0; border:1px solid #0f0; padding:10px; font-size:16px; }
  .keys { display:flex; flex-wrap:wrap; justify-content:center; margin-top:10px; gap:6px; }
  .keys button { 
    background:#111; 
    color:#0f0; 
    border:1px solid #0f0; 
    padding:12px 14px; 
    border-radius:5px; 
    font-size:16px; 
    cursor:pointer; 
    outline:none; 
    user-select:none; 
    -webkit-tap-highlight-color: transparent;
  }
  .keys button:disabled { color:#333; border-color:#333; cursor:default; }
  #wakeBtn { 
    margin-top:10px; 
    padding:5px 8px; 
    font-size:14px; 
    border-radius:5px; 
    cursor:pointer; 
    background:#111; 
    color:#0f0; 
    border:1px solid #0f0;
  }
</style>
</head>
<body>

<h2>Tastiera Ghost</h2>
<div id="status">In attesa di variazione campo...</div>
<textarea id="box" placeholder="Il testo apparirà qui..."></textarea>
<div class="keys" id="keys"></div>
<button id="wakeBtn">Schermo: OFF</button>

<script>
const box = document.getElementById("box");
const status = document.getElementById("status");
const keysContainer = document.getElementById("keys");
const wakeBtn = document.getElementById("wakeBtn");

function setStatus(text){ status.textContent = text; }

// genera tastiera
const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
letters.push("Spazio","Back");
letters.forEach(l=>{
  const btn = document.createElement("button");
  btn.textContent = l;
  btn.dataset.letter = l;
  keysContainer.appendChild(btn);
});

// scrittura
function writeLetter(l){
  if(l==="Spazio") box.value += " ";
  else if(l==="Back") box.value = box.value.slice(0,-1);
  else box.value += l;
}

// touch ultra-sensibile
let lastTouchedBtn = null;
function handleTouch(e){
  e.preventDefault();
  for(let i=0;i<e.touches.length;i++){
    const touch = e.touches[i];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if(el && el.tagName==="BUTTON" && el.dataset.letter){
      if(el !== lastTouchedBtn){
        writeLetter(el.dataset.letter);
        lastTouchedBtn = el;
      }
    }
  }
}
document.addEventListener("touchstart", handleTouch);
document.addEventListener("touchmove", handleTouch);
document.addEventListener("touchend", ()=>{ lastTouchedBtn=null; });

// Back button: cancella tutto se premuto a lungo
let backBtn = Array.from(document.querySelectorAll("button")).find(b=>b.dataset.letter==="Back");
let backInterval = null;
backBtn.addEventListener("touchstart", ()=>{ backInterval = setInterval(()=>{ box.value = ""; }, 100); });
backBtn.addEventListener("touchend", ()=>{ clearInterval(backInterval); backInterval=null; });

// magnetometro
let active=false, lastMag=null, sensitivity=0.1;
if(window.DeviceOrientationEvent){
  window.addEventListener("deviceorientation", e=>{
    if(e.absolute && e.alpha!==null){
      const mag=e.alpha;
      if(lastMag!==null){ active = Math.abs(mag-lastMag)>sensitivity; }
      lastMag=mag;
      setStatus(active ? "✦ Contatto attivo: tastiera abilitata" : "In attesa di variazione campo...");
      document.querySelectorAll(".keys button").forEach(b=>b.disabled=!active);
    }
  });
}else{ setStatus("Sensori non disponibili su questo dispositivo."); }

// NFC
if('NDEFReader' in window){
  const ndef=new NDEFReader();
  ndef.scan().then(()=>{
    setStatus("NFC pronto");
    ndef.onreading=event=>{
      const decoder=new TextDecoder();
      for(const record of event.message.records){
        if(record.recordType==="text") box.value += decoder.decode(record.data);
      }
    };
  }).catch(err=>console.log("Errore NFC:", err));
}

// Wake Lock toggle
let wakeLock=null, wakeActive=false;
async function toggleWakeLock(){
  if('wakeLock' in navigator){
    if(!wakeActive){
      try{
        wakeLock=await navigator.wakeLock.request('screen');
        wakeActive=true;
        wakeBtn.textContent="Schermo: ON";
        setStatus("Wake Lock attivo");
        wakeLock.addEventListener('release', ()=>{
          wakeActive=false;
          wakeBtn.textContent="Schermo: OFF";
          setStatus("Wake Lock rilasciato");
        });
      }catch(err){ console.error(err); setStatus("Wake Lock non disponibile"); }
    }else{
      if(wakeLock) wakeLock.release();
      wakeActive=false;
      wakeBtn.textContent="Schermo: OFF";
      setStatus("Wake Lock disattivato");
    }
  }else{ setStatus("Wake Lock non supportato dal browser"); }
}
wakeBtn.addEventListener("click", toggleWakeLock);
document.addEventListener('visibilitychange', ()=>{ if(wakeActive && document.visibilityState==='visible') toggleWakeLock(); });

// ✅ Service Worker per offline
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js')
    .then(()=>console.log("Service Worker registrato"))
    .catch(err=>console.log("Errore SW:", err));
}
</script>

</body>
</html>
